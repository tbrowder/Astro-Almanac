Moon illumination info in the Cal repository
(this supersedes that info)
============================================

Information extracted from file 'moon-illumination.raku':

Note the repo and the file have lots of Moon info and subroutines
for handling lunation.

# define which Moon illumination fraction we're talking about
enum Phase <Waxing Waning>;

The az/el horizontal coordinate system for astronautical use
------------------------------------------------------------

From Wikipedia:
==============

Altitude (elevation) is the angle between the observer's horizon
and the celestial object. For visible objects it is between zero
and 90 degrees.

Azimuth is the angle of the object around the horizon, usually
messured from true north eastward.

From Jean Meeus' book "Astronomical Algorithms" 
Chapter 48 
"Illuminated Fraction of the Moon's Disk" 
p. 345
================================================================

k = (1 + cos i) / 2; # Eq. 48.1

  where:

  k - illuminated fraction of the Moon
  i - phase angle

cos psi = sin d-s sin d-m + cos d-s cos d-m cos(a-s - a-m); # Eq. 48.2

  where:

  psi - geocentric elongation of the Moon from the Sun
  a-s - right ascension of the Sun
  d-s - declinaion of the Sun
  a-m - right ascension of the Moon
  d-m - declinaion of the Moon

tan i = (R sin psi) / (D - R cos psi); # Eq. 48.3

  where:

  R - distance Earth to Sun
  D - distance Earth to Moon (same units as R)

  The angles psi and i are always between 0 and 180 degrees.
  Once i is known, the illuminated fraction, k, can be
  obtained from Eq. 48.1.

Position Angle of the Moon's bright limb

The position angle of the Moon's bright limb is the angle, chi,
of the midpoint of the illuminated limb of the Moon (C in the
figure on page 345), measured from the North Point of the disk
(not from the adis of rotation of the lunar globe). It can be
obtained from:

tan chi = [cos d-s sin(a-s - a-m)] 
             / [sin d-s cos d-m - cos d-s sin d-m cos(a-s - a-m)]; # Eq. 48.5

The angle chi is in the vicinity of 270 degrees near First Quarter, near
90 degrees after Full Moon. It can be found in the correct quadrant by
applying the atan2 function to the numerator and denominator of the
fraction in Eq. 48.5 (see "the correct quadrant" in Chapter 1).

If chi is the position angle of the midpoint of the bright limb, then
the position angle of the cusps are chi-90 and chi+90 degrees.
The angle chi has the avantage that it ambiguously defines the illuminated
limb of the Moon.

Note that the angle chi is not measured from the direction of the 
observer's zenith. The zenith angle of the bright limb is chi - q
where q is the parallactic angle (see Chapter 14).

Finally, note that Eq. 48.5 is valid in the case of a planet, too.



================================================================
sub get-phase-name($i, # the phase increment index
                   $f, # the fraction of illumination
                  ) {
    # the phases are minimally divided into five increments ($i: 0..4)
    # within each increment we calculate a title as appropriate
    if $i < 3 {
        # new moon waxing to full illumination
        given $f {
            when $f ==   0 { "new moon" }
            when $f <   50 { "waxing crescent" }
            when $f ==  50 { "first quarter" }
            when $f <  100 { "waxing gibbous" }
            when $f == 100 { "full moon" }
            default { die "FATAL: Unexpected fractional illumination factor: $f"; }
        }
    }
    else {
        # full moon waning to total darkness
        given $f {
            when $f ==   0 { "new moon" }
            when $f <   50 { "waxing crescent" }
            when $f ==  50 { "third quarter" }
            when $f <  100 { "waning gibbous" }
            default { die "FATAL: Unexpected fractional illumination factor: $f"; }
        }
    }
}
